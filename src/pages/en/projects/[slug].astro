---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import SectionReveal from '../../../components/SectionReveal';
import { getCollection } from 'astro:content';
import { getImagePath, getBasePath } from '../../../utils/path';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  const paths = await Promise.all(
    projects
      .filter((p) => p.data.lang === 'en')
      .map(async (project) => {
        const { Content } = await project.render();
        return {
          params: { slug: project.slug },
          props: { project, Content },
        };
      })
  );
  return paths;
}

interface Props {
  project: Awaited<ReturnType<typeof getCollection<'projects'>>>[number];
  Content: any;
}

const { project, Content } = Astro.props;
const { data } = project;
const base = getBasePath();

// Get related papers if they exist
let relatedPapers = [];
if (data.relatedPapers && data.relatedPapers.length > 0) {
  const allPapers = await getCollection('papers');
  relatedPapers = data.relatedPapers
    .map((slug) => allPapers.find((p) => p.slug === slug))
    .filter(Boolean);
}
---

<BaseLayout title={data.title} description={data.summary} lang="en">
  <article class="project-page">
    <div class="container">
      <SectionReveal client:load>
        <div class="project-header">
          <a href={`${base}en/projects`.replace(/\/+/g, '/')} class="back-link">← Back to Projects</a>
          <h1>{data.title}</h1>
          <div class="project-meta">
            <span class="year">{data.year}</span>
            {data.tags.map((tag) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        </div>
      </SectionReveal>

      {data.cover && (
        <SectionReveal client:load delay={0.1}>
          <div class="project-cover">
            <img
              src={getImagePath(data.cover)}
              alt={`${data.title} - Cover image`}
              loading="eager"
              width="1200"
              height="600"
            />
          </div>
        </SectionReveal>
      )}

      <SectionReveal client:load delay={0.2}>
        <div class="project-content">
          <Content />
        </div>
      </SectionReveal>

      {(data.gallery && data.gallery.length > 0) || (data.images && data.images.length > 0) ? (
        <SectionReveal client:load delay={0.3}>
          <div class="project-gallery">
            <h2>Project Gallery</h2>
            <div class="gallery-grid gallery-grid--horizontal">
              {data.gallery && data.gallery.length > 0 ? (
                data.gallery.map((item, i) => (
                  <div class="gallery-item">
                    {item.type === 'video' ? (
                      <video controls class="gallery-video" poster={data.cover}>
                        <source src={getImagePath(item.src)} type="video/mp4" />
                        Your browser does not support the video tag.
                      </video>
                    ) : (
                      <img
                        src={getImagePath(item.src)}
                        alt={item.alt || `${data.title} - Image ${i + 1}`}
                        loading="lazy"
                        width="800"
                        height="600"
                      />
                    )}
                    {item.caption && (
                      <p class="gallery-caption">{item.caption}</p>
                    )}
                  </div>
                ))
              ) : (
                data.images?.map((imagePath, i) => (
                  <div class="gallery-item">
                    <img
                      src={getImagePath(imagePath)}
                      alt={`${data.title} - Image ${i + 1}`}
                      loading="lazy"
                      width="800"
                      height="600"
                    />
                  </div>
                ))
              )}
            </div>
          </div>
        </SectionReveal>
      ) : null}

      {(data.demo || data.video) && (
        <SectionReveal client:load delay={0.4}>
          <div class="project-demo">
            <h2>Demo</h2>
            <div class="demo-container">
              {data.video ? (
                <video controls class="demo-video" poster={data.cover}>
                  <source src={getImagePath(data.video)} type="video/mp4" />
                  Your browser does not support the video tag.
                </video>
              ) : data.demo && (data.demo.includes('youtube.com') || data.demo.includes('youtu.be')) ? (
                <iframe
                  src={(() => {
                    let embedUrl = data.demo;
                    if (embedUrl.includes('watch?v=')) {
                      const videoId = embedUrl.split('watch?v=')[1].split('&')[0].split('?')[0];
                      const timeMatch = embedUrl.match(/[?&]t=(\d+)(?:s)?/);
                      const time = timeMatch ? timeMatch[1] : '';
                      embedUrl = `https://www.youtube.com/embed/${videoId}${time ? `?start=${time}` : ''}`;
                    } else if (embedUrl.includes('youtu.be/')) {
                      const videoId = embedUrl.split('youtu.be/')[1].split('?')[0].split('&')[0];
                      const timeMatch = embedUrl.match(/[?&]t=(\d+)(?:s)?/);
                      const time = timeMatch ? timeMatch[1] : '';
                      embedUrl = `https://www.youtube.com/embed/${videoId}${time ? `?start=${time}` : ''}`;
                    }
                    return embedUrl;
                  })()}
                  title={`${data.title} - Demo Video`}
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  class="demo-video"
                ></iframe>
              ) : data.demo ? (
                <a href={data.demo} target="_blank" rel="noopener noreferrer" class="project-link">
                  View Article on Medium →
                </a>
              ) : null}
            </div>
          </div>
        </SectionReveal>
      )}

      {relatedPapers.length > 0 && (
        <SectionReveal client:load delay={0.5}>
          <div class="project-related-papers">
            <h2>Related Publications</h2>
            <div class="related-papers-list">
              {relatedPapers.map((paper) => (
                <a
                  href={`${base}en/papers#${paper.slug}`.replace(/\/+/g, '/')}
                  class="related-paper-link"
                >
                  <span class="paper-title">{paper.data.title}</span>
                  <span class="paper-venue">{paper.data.venue} {paper.data.year}</span>
                </a>
              ))}
            </div>
          </div>
        </SectionReveal>
      )}

      <SectionReveal client:load delay={0.6}>
        <div class="project-links">
          {data.repo && (
            <a href={data.repo} target="_blank" rel="noopener noreferrer" class="project-link">
              View Repository →
            </a>
          )}
          {data.demo && !data.demo.includes('youtube.com') && !data.demo.includes('youtu.be') && (
            <a href={data.demo} target="_blank" rel="noopener noreferrer" class="project-link">
              View Demo →
            </a>
          )}
        </div>
      </SectionReveal>
    </div>
  </article>
</BaseLayout>

<style>
  .project-page {
    padding-block: var(--space-8);
    position: relative;
  }

  .project-page::before {
    content: '';
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, 
      rgba(255, 220, 200, 0.4) 0%, 
      rgba(255, 240, 220, 0.5) 25%,
      rgba(240, 250, 255, 0.5) 50%,
      rgba(220, 240, 255, 0.4) 75%,
      rgba(200, 230, 250, 0.4) 100%);
    background-image: 
      radial-gradient(circle at 20% 30%, rgba(255, 240, 200, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(200, 240, 255, 0.3) 0%, transparent 50%),
      radial-gradient(circle at 50% 50%, rgba(255, 250, 240, 0.2) 0%, transparent 60%);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    z-index: -1;
    pointer-events: none;
  }

  .project-header {
    margin-block-end: var(--space-8);
  }

  .back-link {
    display: inline-block;
    margin-block-end: var(--space-4);
    color: var(--color-accent-1);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: color var(--motion-duration-fast) var(--motion-easing);
  }

  .back-link:hover {
    color: var(--color-accent-2);
  }

  .project-header h1 {
    font-size: var(--font-size-h1);
    margin-block-end: var(--space-4);
    background: var(--gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .project-meta {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
    align-items: center;
  }

  .year {
    font-size: 0.875rem;
    color: var(--color-muted-ink);
    font-weight: 500;
  }

  .tag {
    display: inline-block;
    padding: var(--space-1) var(--space-3);
    background: rgba(234, 199, 199, 0.2);
    border-radius: var(--radius-md);
    font-size: 0.75rem;
    color: var(--color-ink);
    font-weight: 500;
  }

  .project-cover {
    margin-block-end: var(--space-8);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    background: var(--gradient-section);
    max-width: 33%;
    margin-inline: auto;
  }

  .project-cover img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }

  .project-content {
    max-width: 800px;
    margin-inline: auto;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    padding: var(--space-8);
    border-radius: var(--radius-xl);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    margin-block-end: var(--space-8);
  }

  .project-content :global(h2) {
    font-size: var(--font-size-h2);
    margin-block-start: var(--space-8);
    margin-block-end: var(--space-4);
  }

  .project-content :global(h3) {
    font-size: var(--font-size-h3);
    margin-block-start: var(--space-6);
    margin-block-end: var(--space-3);
  }

  .project-content :global(p) {
    font-size: 1rem;
    line-height: 1.8;
    margin-block-end: var(--space-4);
  }

  .project-content :global(ul),
  .project-content :global(ol) {
    margin-block-end: var(--space-4);
    padding-inline-start: var(--space-6);
  }

  .project-content :global(li) {
    font-size: 1rem;
    line-height: 1.8;
    margin-block-end: var(--space-2);
  }

  .project-content :global(a) {
    color: var(--color-accent-1);
    text-decoration: underline;
  }

  .project-gallery {
    margin-block: var(--space-8);
  }

  .project-gallery h2 {
    font-size: var(--font-size-h2);
    margin-block-end: var(--space-6);
    text-align: center;
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--space-4);
  }

  .gallery-grid--horizontal {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-3);
  }

  @media (min-width: 768px) {
    .gallery-grid--horizontal {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
  }

  .gallery-item {
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-card);
    background: var(--gradient-section);
    transition: transform var(--motion-duration-normal) var(--motion-easing-smooth);
  }

  .gallery-item:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-card-hover);
  }

  .gallery-item {
    max-width: 33%;
    margin-inline: auto;
    display: flex;
    flex-direction: column;
  }
  
  .gallery-grid--horizontal .gallery-item {
    max-width: 30%;
  }

  .gallery-item img,
  .gallery-item video {
    width: 100%;
    max-width: 100%;
    height: auto;
    display: block;
    object-fit: contain;
  }

  .gallery-video {
    border-radius: var(--radius-lg);
    background: var(--gradient-section);
  }

  .gallery-caption {
    margin-block-start: var(--space-2);
    font-size: 0.75rem;
    color: var(--color-muted-ink);
    text-align: center;
  }

  .project-demo {
    margin-block: var(--space-8);
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    padding: var(--space-6);
    border-radius: var(--radius-xl);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .project-demo h2 {
    font-size: var(--font-size-h2);
    margin-block-end: var(--space-6);
    text-align: center;
  }

  .demo-container {
    width: 100%;
    max-width: 800px;
    margin-inline: auto;
  }

  .demo-video {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: var(--radius-lg);
    border: none;
    box-shadow: var(--shadow-lg);
  }

  .project-links {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
    flex-wrap: wrap;
    margin-block-start: var(--space-8);
  }

  .project-link {
    display: inline-block;
    padding: var(--space-3) var(--space-6);
    background: var(--gradient-button);
    color: white;
    text-decoration: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    transition: all var(--motion-duration-normal) var(--motion-easing-smooth);
    box-shadow: var(--shadow-soft);
  }

  .project-link:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-button-hover);
  }

  .project-related-papers {
    margin-block: var(--space-8);
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    padding: var(--space-6);
    border-radius: var(--radius-xl);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .project-related-papers h2 {
    font-size: var(--font-size-h2);
    margin-block-end: var(--space-6);
    text-align: center;
  }

  .related-papers-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .related-paper-link {
    display: flex;
    flex-direction: column;
    padding: var(--space-4);
    background: rgba(255, 255, 255, 0.6);
    border-radius: var(--radius-md);
    text-decoration: none;
    transition: all var(--motion-duration-normal) var(--motion-easing-smooth);
    border: 1px solid rgba(0, 0, 0, 0.08);
  }

  .related-paper-link:hover {
    background: rgba(255, 255, 255, 0.9);
    transform: translateX(4px);
    box-shadow: var(--shadow-soft);
  }

  .paper-title {
    font-weight: 600;
    color: var(--color-ink);
    margin-block-end: var(--space-1);
    font-size: 0.9375rem;
  }

  .paper-venue {
    font-size: 0.8125rem;
    color: var(--color-muted-ink);
  }
</style>

