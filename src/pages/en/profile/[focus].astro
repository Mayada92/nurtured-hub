---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import ProfileHeader from '../../../components/ProfileHeader.astro';
import ProjectCard from '../../../components/ProjectCard.astro';
import PostCard from '../../../components/PostCard.astro';
import PaperCard from '../../../components/PaperCard.astro';
import VolunteeringCard from '../../../components/VolunteeringCard.astro';
import TrainingCard from '../../../components/TrainingCard.astro';
import SpeakingCard from '../../../components/SpeakingCard.astro';
import CourseCard from '../../../components/CourseCard.astro';
import WorkCard from '../../../components/WorkCard.astro';
import ExpandableWorkExample from '../../../components/ExpandableWorkExample.astro';
import TableOfContents from '../../../components/TableOfContents.astro';
import { getCollection } from 'astro:content';
import { organizeByDomain, getDomainOrder, domainLabels } from '../../../utils/organize-by-domain';
import type { Domain } from '../../../utils/organize-by-domain';

export async function getStaticPaths() {
  const profiles = await getCollection('profiles');
  return profiles.map((profile) => ({
    params: { focus: profile.data.focus },
  }));
}

interface Props {
  focus: string;
}

const { focus } = Astro.params;
const lang = 'en';
const base = import.meta.env.BASE_URL;

const profile = (await getCollection('profiles')).find((p) => p.data.focus === focus);
if (!profile) {
  return Astro.redirect(`${base}en/profile`, 404);
}

const { data } = profile;
const allProjects = await getCollection('projects');
const allPosts = await getCollection('posts').catch(() => []);
const allPapers = await getCollection('papers').catch(() => []);
const allVolunteering = await getCollection('volunteering').catch(() => []);
const allTraining = await getCollection('training').catch(() => []);
const allSpeaking = await getCollection('speaking').catch(() => []);
const allCourses = await getCollection('courses').catch(() => []);
const allWork = await getCollection('work').catch(() => []);

// Filter by language
const volunteering = allVolunteering.filter((v) => v.data.lang === lang);
const training = allTraining.filter((t) => t.data.lang === lang);
const speaking = allSpeaking.filter((s) => s.data.lang === lang);
const courses = allCourses.filter((c) => c.data.lang === lang);
const work = allWork.filter((w) => w.data.lang === lang);

// Separate hackathons
const hackathons = volunteering.filter((v) => v.data.is_hackathon);
const nonHackathonVolunteering = volunteering.filter((v) => !v.data.is_hackathon);

// Map profile focus to primary domain
const focusToDomain: Record<string, Domain[]> = {
  'children-education': ['educational-psychology'],
  'data-science': ['data-science'],
  'volunteering': ['general'], // Volunteering can span all domains
  'engineering': ['engineering'],
};

// Get relevant domains for this profile focus
const relevantDomains = focusToDomain[focus] || getDomainOrder();

// Filter work by relevant domains for this profile
const workForProfile = work.filter((w) => {
  const workDomains = Array.isArray(w.data.domain) ? w.data.domain : [w.data.domain];
  return workDomains.some((d) => relevantDomains.includes(d));
});

// Organize by domain - only show relevant domains
const workByDomain = organizeByDomain(workForProfile, lang);
const coursesByDomain = organizeByDomain(courses, lang);
const trainingByDomain = organizeByDomain(training, lang);
const speakingByDomain = organizeByDomain(speaking, lang);
const projectsByDomain = organizeByDomain(
  allProjects.filter((p) => p.data.lang === lang && data.include_tags.some((tag) => p.data.tags.includes(tag))),
  lang
);

const focusLabels: Record<string, string> = {
  'children-education': 'Children & Education',
  'data-science': 'Data Science',
  volunteering: 'Volunteering',
  engineering: 'Engineering',
};

const title = focusLabels[focus] || focus;

// Build headings for TOC
const headings = [
  { id: 'overview', text: 'Overview', level: 2 },
];

if (nonHackathonVolunteering.length > 0 || hackathons.length > 0) {
  headings.push({ id: 'volunteering', text: 'Volunteering', level: 2 });
  if (hackathons.length > 0) {
    headings.push({ id: 'hackathons', text: 'Hackathons', level: 3 });
  }
}
if (training.length > 0) headings.push({ id: 'training', text: 'Training & Lectures', level: 2 });
if (speaking.length > 0) headings.push({ id: 'speaking', text: 'Public Speaking & Knowledge Sharing', level: 2 });
if (courses.length > 0) headings.push({ id: 'courses', text: 'Courses', level: 2 });

// Add domain sections for work - only relevant domains
relevantDomains.forEach((domain) => {
  if (workByDomain[domain] && workByDomain[domain].length > 0) {
    headings.push({ id: `work-${domain}`, text: `${domainLabels.en[domain]} - Work`, level: 2 });
  }
  if (projectsByDomain[domain] && projectsByDomain[domain].length > 0) {
    headings.push({ id: `projects-${domain}`, text: `${domainLabels.en[domain]} - Projects`, level: 2 });
  }
});

if (allPosts.filter((p) => p.data.lang === lang && data.pin_posts.includes(p.slug)).length > 0) {
  headings.push({ id: 'writing', text: 'Writing', level: 2 });
}
if (allPapers.filter((p) => p.data.lang === lang && data.pin_papers.includes(p.slug)).length > 0) {
  headings.push({ id: 'papers', text: 'Papers', level: 2 });
}
---

<BaseLayout title={title} description={data.headline} lang="en">
  <div class="content profile-content">
    <div class="profile-layout">
      <aside class="profile-toc">
        <TableOfContents headings={headings} />
      </aside>
      <article class="profile-main">
        <ProfileHeader title={title} headline={data.headline} focus={focus} />
        
        <section id="overview">
          <h2>Overview</h2>
          <p>{data.headline}</p>
        </section>

        {/* Volunteering Section */}
        {(nonHackathonVolunteering.length > 0 || hackathons.length > 0) && (
          <section id="volunteering">
            <h2>Volunteering</h2>
            {nonHackathonVolunteering.length > 0 && (
              <div class="section-content">
                {nonHackathonVolunteering
                  .sort((a, b) => new Date(b.data.start_date).getTime() - new Date(a.data.start_date).getTime())
                  .map((vol) => (
                    <VolunteeringCard volunteering={vol} />
                  ))}
              </div>
            )}
            {hackathons.length > 0 && (
              <div id="hackathons">
                <h3>Hackathons</h3>
                <div class="section-content">
                  {hackathons
                    .sort((a, b) => new Date(b.data.start_date).getTime() - new Date(a.data.start_date).getTime())
                    .map((hack) => (
                      <VolunteeringCard volunteering={hack} />
                    ))}
                </div>
              </div>
            )}
          </section>
        )}

        {/* Training & Lectures Section */}
        {training.length > 0 && (
          <section id="training">
            <h2>Training & Lectures</h2>
            <div class="section-content">
              {training
                .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
                .map((t) => (
                  <TrainingCard training={t} />
                ))}
            </div>
          </section>
        )}

        {/* Public Speaking & Knowledge Sharing Section */}
        {speaking.length > 0 && (
          <section id="speaking">
            <h2>Public Speaking & Knowledge Sharing</h2>
            <div class="section-content">
              {speaking
                .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
                .map((s) => (
                  <SpeakingCard speaking={s} />
                ))}
            </div>
          </section>
        )}

        {/* Courses Section - Organized by Domain */}
        {courses.length > 0 && (
          <section id="courses">
            <h2>Courses</h2>
            {getDomainOrder().map((domain) => {
              const domainCourses = coursesByDomain[domain];
              if (!domainCourses || domainCourses.length === 0) return null;
              return (
                <div id={`courses-${domain}`} class="domain-section">
                  <h3>{domainLabels.en[domain]}</h3>
                  <div class="section-content">
                    {domainCourses
                      .sort((a, b) => {
                        // Sort by year descending, then by term if available
                        if (b.data.year !== a.data.year) return b.data.year - a.data.year;
                        return (b.data.term || '').localeCompare(a.data.term || '');
                      })
                      .map((course) => (
                        <CourseCard course={course} />
                      ))}
                  </div>
                </div>
              );
            })}
          </section>
        )}

        {/* Work & Projects - Organized by Domain (filtered by profile focus) */}
        {relevantDomains.map((domain) => {
          const domainWork = workByDomain[domain];
          const domainProjects = projectsByDomain[domain];
          
          // Work examples (BSU/UC Berkeley) - shown as expandable cards
          const workExamples = domain === 'educational-psychology' 
            ? [
                {
                  title: 'EDPS 604 - Praise Brochure',
                  institution: 'Boise State University',
                  course: 'EDPS 604',
                  year: 2024,
                  description: 'Created an educational brochure on the topic of praise in educational settings, focusing on effective praise strategies and their impact on student motivation.',
                  images: [],
                  files: [
                    { name: 'Praise Brochure.pdf', url: '/__private_content/BSU Work/Praise Brochure EDPS 604 (1).pdf', type: 'pdf' },
                  ],
                  domain: domain as 'educational-psychology',
                },
              ]
            : domain === 'data-science'
            ? [
                {
                  title: 'Research Design Final Project - DATASCI 201',
                  institution: 'UC Berkeley',
                  course: 'DATASCI 201',
                  year: 2024,
                  description: 'Comprehensive research design project demonstrating statistical analysis and experimental design principles for data science applications.',
                  images: [],
                  files: [],
                  domain: domain as 'data-science',
                },
                {
                  title: 'Usability Study - Data Visualization',
                  institution: 'UC Berkeley',
                  course: 'Data Viz 207',
                  year: 2024,
                  description: 'Conducted a comprehensive usability study for data visualization tools, analyzing user interactions and effectiveness metrics.',
                  images: [],
                  files: [],
                  domain: domain as 'data-science',
                },
                {
                  title: 'ONGB Wizearly Internship Project',
                  institution: 'UC Berkeley / ONGB',
                  course: 'MIDS Program',
                  year: 2024,
                  description: 'Collaborative internship project working with ONGB organization, developing solutions using data science methodologies.',
                  images: [],
                  files: [],
                  domain: domain as 'data-science',
                },
              ]
            : [];
          
          if ((!domainWork || domainWork.length === 0) && 
              (!domainProjects || domainProjects.length === 0) && 
              workExamples.length === 0) {
            return null;
          }
          return (
            <section id={`work-${domain}`}>
              <h2>{domainLabels.en[domain]}</h2>
              
              {/* Work Examples (Expandable) */}
              {workExamples.length > 0 && (
                <div class="subsection">
                  <h3>Work Examples</h3>
                  <p class="subsection-intro">
                    Selected work from academic projects and internships. Click to expand and view details, files, and materials.
                  </p>
                  <div class="section-content">
                    {workExamples.map((example) => (
                      <ExpandableWorkExample
                        title={example.title}
                        institution={example.institution}
                        course={example.course}
                        year={example.year}
                        description={example.description}
                        images={example.images}
                        files={example.files}
                        domain={example.domain}
                        lang={lang}
                      />
                    ))}
                  </div>
                </div>
              )}
              
              {/* Work Experience */}
              {domainWork && domainWork.length > 0 && (
                <div class="subsection">
                  <h3>Work Experience</h3>
                  <div class="section-content">
                    {domainWork
                      .sort((a, b) => {
                        // Sort by ongoing first, then by start date descending
                        if (a.data.ongoing !== b.data.ongoing) return a.data.ongoing ? -1 : 1;
                        return new Date(b.data.start_date).getTime() - new Date(a.data.start_date).getTime();
                      })
                      .map((w) => (
                        <WorkCard work={w} />
                      ))}
                  </div>
                </div>
              )}

              {/* Projects */}
              {domainProjects && domainProjects.length > 0 && (
                <div class="subsection">
                  <h3>Projects</h3>
                  <div class="section-content">
                    {domainProjects
                      .sort((a, b) => b.data.year - a.data.year)
                      .map((p) => (
                        <ProjectCard project={p} />
                      ))}
                  </div>
                </div>
              )}
            </section>
          );
        })}

        {/* Writing */}
        {allPosts.filter((p) => p.data.lang === lang && data.pin_posts.includes(p.slug)).length > 0 && (
          <section id="writing">
            <h2>Writing</h2>
            <div class="section-content">
              {allPosts
                .filter((p) => p.data.lang === lang && data.pin_posts.includes(p.slug))
                .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
                .map((post) => (
                  <PostCard post={post} />
                ))}
            </div>
          </section>
        )}

        {/* Papers */}
        {allPapers.filter((p) => p.data.lang === lang && data.pin_papers.includes(p.slug)).length > 0 && (
          <section id="papers">
            <h2>Papers</h2>
            <div class="section-content">
              {allPapers
                .filter((p) => p.data.lang === lang && data.pin_papers.includes(p.slug))
                .sort((a, b) => b.data.year - a.data.year)
                .map((paper) => (
                  <PaperCard paper={paper} />
                ))}
            </div>
          </section>
        )}
      </article>
    </div>
  </div>
</BaseLayout>

<style>
  :global(body)::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url('/images/background/background5.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    opacity: 0.2;
    z-index: -1;
    pointer-events: none;
  }
  .profile-content {
    max-width: 100%;
    padding-inline: 0;
  }

  .profile-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: var(--space-6);
    align-items: start;
    position: relative;
    max-width: 100%;
  }

  .profile-toc {
    position: sticky;
    top: calc(var(--header-height, 80px) + var(--space-4));
    align-self: start;
    left: 0;
    padding-inline-start: var(--space-4);
  }

  .profile-main {
    min-width: 0; /* Prevent grid overflow */
    margin-inline-start: 0;
    padding-inline-end: var(--space-4);
  }

  @media (max-width: 1024px) {
    .profile-layout {
      display: block;
    }

    .profile-toc {
      position: static !important;
      margin-block-end: var(--space-6);
    }
  }

  section {
    margin-block-end: var(--space-5);
  }

  section h2 {
    margin-block-end: var(--space-3);
    margin-block-start: var(--space-4);
    scroll-margin-block-start: var(--space-4);
    font-size: 1.1rem;
    font-weight: 600;
    padding-block-end: var(--space-2);
    border-block-end: 1px solid rgba(0, 0, 0, 0.1);
  }

  section h3 {
    margin-block-end: var(--space-2);
    margin-block-start: var(--space-3);
    font-size: 0.95rem;
    font-weight: 600;
  }

  .section-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .subsection {
    margin-block-end: var(--space-4);
  }

  .domain-section {
    margin-block-end: var(--space-4);
  }

  .subsection-intro {
    color: var(--color-muted-ink);
    font-size: var(--font-size-small);
    margin-block-end: var(--space-2);
    font-style: italic;
  }
</style>
